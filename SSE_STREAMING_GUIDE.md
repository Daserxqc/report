# MCP Server-Sent Events (SSE) æµå¼å“åº”å®ç°æŒ‡å—

## æ¦‚è¿°

æ‚¨çš„MCPæœåŠ¡å™¨ç°åœ¨å·²ç»å®Œå…¨å®ç°äº†ç¬¦åˆJSON-RPC 2.0è§„èŒƒçš„Server-Sent Eventsæµå¼å“åº”åŠŸèƒ½ã€‚è¿™ä¸ªå®ç°åŒ…æ‹¬ï¼š

- âœ… **è¿›åº¦æ›´æ–°æ¶ˆæ¯** - å®æ—¶åé¦ˆä»»åŠ¡æ‰§è¡Œè¿›åº¦
- âœ… **æ¨¡å‹ç”¨é‡æ¶ˆæ¯** - è·Ÿè¸ªAIæ¨¡å‹çš„Tokenæ¶ˆè€—
- âœ… **æœ€ç»ˆæˆåŠŸç»“æœ** - ä»»åŠ¡å®Œæˆæ—¶è¿”å›ç»“æ„åŒ–ç»“æœ
- âœ… **é”™è¯¯ä¿¡æ¯** - ä»»åŠ¡å¤±è´¥æ—¶çš„è¯¦ç»†é”™è¯¯æŠ¥å‘Š

## æ¶ˆæ¯æ ¼å¼è§„èŒƒ

### 1. è¿›åº¦æ›´æ–°æ¶ˆæ¯

ç¬¦åˆè§„èŒƒçš„è¿›åº¦æ›´æ–°æ¶ˆæ¯æ ¼å¼ï¼š

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "level": "info",
    "data": {
      "msg": {
        "status": "generating_sections",
        "message": "å®Œæˆæ•™å­¦ç›®æ ‡çš„ç”Ÿæˆä»»åŠ¡",
        "details": {
          "id": 0,
          "name": "æ•™å­¦ç›®æ ‡",
          "content": "## ä¸€ã€æ•™å­¦ç›®æ ‡\n\n- é€šè¿‡æ¡ˆä¾‹åˆ†æ..."
        }
      }
    },
    "extra": null
  }
}
```

### 2. æ¨¡å‹ç”¨é‡æ¶ˆæ¯

```json
{
  "jsonrpc": "2.0",
  "method": "notifications/message",
  "params": {
    "data": {
      "msg": {
        "type": "model_usage",
        "data": {
          "model_provider": "doubao",
          "model_name": "doubao-1-5-pro-32k-250115",
          "input_tokens": 560,
          "output_tokens": 830
        }
      }
    }
  }
}
```

### 3. æœ€ç»ˆæˆåŠŸç»“æœ

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "{\"status\":\"completed\",\"task\":\"ç”ŸæˆæŠ¥å‘Š\"...}"
      }
    ],
    "structuredContent": {
      "status": "completed",
      "task": "ç”ŸæˆAI Agenté¢†åŸŸæŠ¥å‘Š",
      "report_content": "# å®Œæ•´æŠ¥å‘Šå†…å®¹...",
      "metadata": {
        "topic": "AI Agent",
        "sections_count": 5,
        "final_quality_score": 8.2
      }
    },
    "isError": false
  }
}
```

### 4. é”™è¯¯ä¿¡æ¯

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": -32603,
    "message": "Internal error",
    "data": {
      "type": "report_generation_failed",
      "message": "æŠ¥å‘Šç”Ÿæˆæ¨¡å‹æœªèƒ½è¿”å›æœ‰æ•ˆå†…å®¹ã€‚"
    }
  }
}
```

## æœåŠ¡å™¨ç«¯ç‚¹

### ä¸»è¦æœåŠ¡å™¨
- **MCPæœåŠ¡å™¨**: `http://localhost:8000/mcp` (FastMCP)
- **SSEæœåŠ¡å™¨**: `http://localhost:8001` (FastAPI)

### SSEæµå¼ç«¯ç‚¹
- **POST** `/mcp/streaming/orchestrator` - å¯åŠ¨æµå¼æŠ¥å‘Šç”Ÿæˆ
- **GET** `/mcp/streaming/sessions/{session_id}` - æŸ¥è¯¢ä¼šè¯çŠ¶æ€

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡å™¨

```bash
# å®‰è£…ä¾èµ–
pip install -r requirements.txt

# å¯åŠ¨æœåŠ¡å™¨ï¼ˆåŒæ—¶å¯åŠ¨MCPå’ŒSSEæœåŠ¡ï¼‰
python main.py
```

æœåŠ¡å™¨å¯åŠ¨åä¼šçœ‹åˆ°ï¼š
```
ğŸš€ å¯åŠ¨MCPæœåŠ¡å™¨...
ğŸ“¡ FastAPI SSEæœåŠ¡å™¨å·²å¯åŠ¨ (ç«¯å£8001)
```

### 2. æµ‹è¯•æµå¼å“åº”

ä½¿ç”¨æä¾›çš„æµ‹è¯•å®¢æˆ·ç«¯ï¼š

```bash
python test_sse_client.py
```

### 3. æ‰‹åŠ¨è°ƒç”¨SSEç«¯ç‚¹

```bash
curl -X POST http://localhost:8001/mcp/streaming/orchestrator \
  -H "Content-Type: application/json" \
  -H "Accept: text/event-stream" \
  -d '{
    "task": "ç”ŸæˆAI Agenté¢†åŸŸæœ€è¿‘ä¸€å‘¨çš„è¡Œä¸šé‡å¤§äº‹ä»¶æŠ¥å‘Š",
    "task_type": "news_report",
    "kwargs": {
      "days": 7,
      "quality_threshold": 7.0,
      "max_iterations": 2,
      "auto_confirm": true
    }
  }'
```

### 4. åœ¨Cursorä¸­ä½¿ç”¨MCPå·¥å…·

é…ç½®Cursorçš„MCPå®¢æˆ·ç«¯åï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ï¼š

```
orchestrator_mcp_streaming("ç”ŸæˆAI Agentè¡Œä¸šæŠ¥å‘Š", task_type="news_report")
```

## æµå¼å“åº”æµç¨‹

1. **ä¼šè¯å¯åŠ¨** - è¿”å›session_id
2. **æ„å›¾è¯†åˆ«** - åˆ†æä»»åŠ¡æ„å›¾
3. **å¤§çº²ç”Ÿæˆ** - åˆ›å»ºæŠ¥å‘Šç»“æ„
4. **å†…å®¹æ£€ç´¢** - å¹¶è¡Œæœç´¢ç›¸å…³ä¿¡æ¯
5. **è´¨é‡è¯„ä¼°** - 5ç»´åº¦è´¨é‡åˆ†æ
6. **å†…å®¹ç”Ÿæˆ** - é€ç« èŠ‚ç”Ÿæˆå†…å®¹ï¼ˆå¸¦å®æ—¶è¿›åº¦ï¼‰
7. **æ‘˜è¦ç”Ÿæˆ** - åˆ›å»ºæ‰§è¡Œæ‘˜è¦
8. **æŠ¥å‘Šç»„è£…** - æœ€ç»ˆæŠ¥å‘Šç»„è£…
9. **ä¼šè¯ç»“æŸ** - è¿”å›å®Œæ•´ç»“æœ

## ä¸»è¦ç‰¹æ€§

### ğŸ”„ å®æ—¶è¿›åº¦åé¦ˆ
- 7æ­¥éª¤å·¥ä½œæµç¨‹çš„å®æ—¶è¿›åº¦
- æ¯ä¸ªç« èŠ‚ç”Ÿæˆçš„è¯¦ç»†è¿›åº¦
- è´¨é‡è¯„ä¼°çš„5ç»´åº¦è¯„åˆ†

### ğŸ“Š æ¨¡å‹ç”¨é‡è·Ÿè¸ª
- Tokenæ¶ˆè€—ç»Ÿè®¡
- æ¨¡å‹æä¾›å•†å’Œåç§°
- è¾“å…¥/è¾“å‡ºTokenè®¡æ•°

### ğŸ¯ æ™ºèƒ½å†…å®¹ç”Ÿæˆ
- AIæ„å›¾è¯†åˆ«
- 5ç»´åº¦è´¨é‡è¯„ä¼°ï¼ˆç›¸å…³æ€§ã€æ·±åº¦ã€å‡†ç¡®æ€§ã€å®Œæ•´æ€§ã€æ—¶æ•ˆæ€§ï¼‰
- æ™ºèƒ½ç¼ºå£åˆ†æå’Œè¡¥å……æœç´¢
- ä¸“ä¸šå†…å®¹æ’°å†™

### ğŸ”§ é”™è¯¯å¤„ç†
- å®Œå–„çš„é”™è¯¯æ•è·å’ŒæŠ¥å‘Š
- ç¬¦åˆJSON-RPC 2.0é”™è¯¯æ ¼å¼
- è¯¦ç»†çš„é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯

## é…ç½®é€‰é¡¹

### ä»»åŠ¡å‚æ•°
- `task`: ä»»åŠ¡æè¿°
- `task_type`: ä»»åŠ¡ç±»å‹ (`news_report`, `research_report`, `industry_analysis`, `auto`)
- `days`: æœç´¢æ—¶é—´èŒƒå›´ï¼ˆé»˜è®¤7å¤©ï¼‰
- `quality_threshold`: è´¨é‡é—¨æ§›ï¼ˆé»˜è®¤7.0/10ï¼‰
- `max_iterations`: æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤3ï¼‰
- `auto_confirm`: è‡ªåŠ¨ç¡®è®¤å¤§çº²ï¼ˆé»˜è®¤trueï¼‰

### ç¯å¢ƒå˜é‡
ç¡®ä¿åœ¨`.env`æ–‡ä»¶ä¸­é…ç½®å¿…è¦çš„APIå¯†é’¥ï¼š
```
TAVILY_API_KEY=your_key
BRAVE_API_KEY=your_key
GOOGLE_API_KEY=your_key
OPENAI_API_KEY=your_key
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥å¤±è´¥**
   - ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
   - æ£€æŸ¥ç«¯å£8000å’Œ8001æ˜¯å¦å¯ç”¨

2. **æœç´¢æœåŠ¡ä¸å¯ç”¨**
   - æ£€æŸ¥APIå¯†é’¥é…ç½®
   - éªŒè¯ç½‘ç»œè¿æ¥

3. **æ¨¡å‹è°ƒç”¨å¤±è´¥**
   - ç¡®è®¤LLM APIå¯†é’¥æ­£ç¡®
   - æ£€æŸ¥æ¨¡å‹æœåŠ¡å¯ç”¨æ€§

### æ—¥å¿—æŸ¥çœ‹
æœåŠ¡å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼š
```
ğŸ“¡ [æµå¼è¿›åº¦] task_started: å¼€å§‹æ‰§è¡Œä»»åŠ¡
ğŸ¤– AIæˆåŠŸç”Ÿæˆ 3 ä¸ªé’ˆå¯¹æ€§æŸ¥è¯¢
ğŸ“Š [ç¬¬1è½®è¯„ä¼°] 5ç»´åº¦è´¨é‡åˆ†æ: ç›¸å…³æ€§8.5/10
```

## æŠ€æœ¯æ¶æ„

- **FastMCP**: ä¸»MCPæœåŠ¡å™¨æ¡†æ¶
- **FastAPI**: SSEæµå¼å“åº”æœåŠ¡å™¨
- **ThreadPoolExecutor**: å¹¶è¡Œæœç´¢å’Œå¤„ç†
- **JSON-RPC 2.0**: æ ‡å‡†æ¶ˆæ¯åè®®
- **Server-Sent Events**: æµå¼æ•°æ®ä¼ è¾“

è¿™ä¸ªå®ç°å®Œå…¨ç¬¦åˆæ‚¨æä¾›çš„SSEæ¶ˆæ¯æ ¼å¼è§„èŒƒï¼Œæä¾›äº†ä¸“ä¸šçº§çš„æµå¼æŠ¥å‘Šç”Ÿæˆèƒ½åŠ›ã€‚

