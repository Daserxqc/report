"""
æŠ€æœ¯åˆ›æ–°æ–°é—»åˆ†æå™¨ - å¹¶è¡Œå¤„ç†ç‰ˆæœ¬
ä¸“é—¨è´Ÿè´£æŠ€æœ¯åˆ›æ–°æ–°é—»çš„æ·±åº¦åˆ†æï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
"""

import time
from typing import List, Dict, Any, Optional
import threading

class InnovationNewsAnalyzer:
    """æŠ€æœ¯åˆ›æ–°æ–°é—»åˆ†æå™¨ - å¹¶è¡Œç‰ˆæœ¬"""
    
    def __init__(self, llm_processor, max_workers: int = 2):
        """
        åˆå§‹åŒ–æŠ€æœ¯åˆ›æ–°æ–°é—»åˆ†æå™¨
        
        Args:
            llm_processor: LLMå¤„ç†å™¨å®ä¾‹
            max_workers: æœ€å¤§å¹¶è¡Œå·¥ä½œçº¿ç¨‹æ•°
        """
        self.llm_processor = llm_processor
        self.max_workers = max_workers
        self.analysis_lock = threading.Lock()
        
    def analyze_innovation_news_parallel(self, topic: str, innovation_news: List[Dict]) -> str:
        """
        å¹¶è¡Œåˆ†ææŠ€æœ¯åˆ›æ–°æ–°é—»
        
        Args:
            topic: è¡Œä¸šä¸»é¢˜
            innovation_news: æŠ€æœ¯åˆ›æ–°æ–°é—»åˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„æŠ€æœ¯åˆ›æ–°åˆ†ææŠ¥å‘Š
        """
        if not innovation_news:
            return f"## ğŸ”¬ æŠ€æœ¯åˆ›æ–°ä¸æ–°äº§å“æ·±åº¦è§£æ\n\nğŸ“Š **è§‚å¯Ÿ**: å½“å‰æ—¶é—´çª—å£å†…{topic}è¡Œä¸šæŠ€æœ¯åˆ›æ–°æ´»åŠ¨ç›¸å¯¹å¹³é™ã€‚\n\n"
        
        start_time = time.time()
        print(f"ğŸ§ª [æŠ€æœ¯åˆ›æ–°åˆ†æ] å¼€å§‹å¹¶è¡Œåˆ†æ{len(innovation_news)}é¡¹æŠ€æœ¯åˆ›æ–°...")
        
        try:
            all_news_text = "\n\n".join([
                f"æ ‡é¢˜: {item.get('title', 'æ— æ ‡é¢˜')}\nå†…å®¹: {item.get('content', 'æ— å†…å®¹')[:500]}...\næ¥æº: {item.get('source', 'æœªçŸ¥')}"
                for item in innovation_news
            ])
            
            enhanced_prompt = f"""
            ä½œä¸º{topic}è¡Œä¸šçš„æŠ€æœ¯ä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹æŠ€æœ¯åˆ›æ–°è¿›è¡Œæ™ºèƒ½ç­›é€‰ã€å»é‡å’Œæ·±åº¦åˆ†æï¼š
            
            {all_news_text}
            
            ğŸ” **æ™ºèƒ½ç­›é€‰ä»»åŠ¡**ï¼š
            1. **å»é‡è¯†åˆ«**ï¼šè¯†åˆ«ç›¸ä¼¼æˆ–é‡å¤çš„æŠ€æœ¯åˆ›æ–°æŠ¥é“ï¼Œåˆå¹¶ç›¸åŒæŠ€æœ¯çš„ä¸åŒæŠ¥é“
            2. **é‡è¦æ€§è¯„ä¼°**ï¼šè¯„ä¼°æ¯ä¸ªæŠ€æœ¯åˆ›æ–°çš„çªç ´æ€§å’Œå½±å“åŠ›
            3. **å¤šæ ·æ€§ä¿è¯**ï¼šç¡®ä¿æ¶µç›–ä¸åŒæŠ€æœ¯é¢†åŸŸå’Œåº”ç”¨æ–¹å‘
            
            ğŸ”¬ **æŠ€æœ¯åˆ†ææ¡†æ¶**:
            1. **åˆ›æ–°çªç ´æ€§è¯„ä¼°**: ç­›é€‰å‡ºçš„æŠ€æœ¯çš„é¢ è¦†æ€§ç¨‹åº¦å¦‚ä½•ï¼Ÿ
            2. **æŠ€æœ¯æˆç†Ÿåº¦åˆ†æ**: å½“å‰å¤„äºä»€ä¹ˆå‘å±•é˜¶æ®µï¼Ÿ
            3. **å•†ä¸šåŒ–å¯è¡Œæ€§**: è·ç¦»è§„æ¨¡åŒ–åº”ç”¨è¿˜æœ‰å¤šè¿œï¼Ÿ
            4. **ç«äº‰æ ¼å±€å½±å“**: å¯¹ç°æœ‰æŠ€æœ¯è·¯çº¿çš„å†²å‡»ç¨‹åº¦ï¼Ÿ
            5. **æœªæ¥å‘å±•è¶‹åŠ¿**: æŠ€æœ¯æ¼”è¿›çš„å¯èƒ½æ–¹å‘ï¼Ÿ
            
            ğŸ¤” **åˆ†æå¸ˆæ€è€ƒè¿‡ç¨‹**:
            - é¦–å…ˆå»é™¤é‡å¤æŠ€æœ¯æŠ¥é“ï¼Œä¿ç•™ä¿¡æ¯æœ€å…¨é¢çš„ç‰ˆæœ¬
            - ç„¶åè¯„ä¼°æŠ€æœ¯çš„åŸåˆ›æ€§å’Œçªç ´æ€§
            - æ¥ç€åˆ†ææŠ€æœ¯çš„å®ç”¨æ€§å’Œå•†ä¸šä»·å€¼
            - æœ€åé¢„æµ‹å¯¹è¡Œä¸šç”Ÿæ€çš„é•¿è¿œå½±å“
            
            è¯·æä¾›å®¢è§‚ã€ä¸“ä¸šçš„æŠ€æœ¯è§£è¯»ï¼Œè¦æ±‚è¯¦ç»†æ·±å…¥ï¼Œå­—æ•°1500-2000å­—ã€‚
             
             ğŸ“ **å†…å®¹è¦æ±‚**:
             - å¦‚æœå‘ç°ç›¸åŒæŠ€æœ¯çš„å¤šä¸ªæŠ¥é“ï¼Œè¯·åˆå¹¶ä¿¡æ¯åªåˆ†æä¸€æ¬¡
             - æ¯ä¸ªç‹¬ç‰¹æŠ€æœ¯åˆ›æ–°éƒ½è¦è¯¦ç»†å±•å¼€åˆ†æ
             - æä¾›å…·ä½“çš„æŠ€æœ¯ç»†èŠ‚å’Œåº”ç”¨åœºæ™¯
             - åŒ…å«å¸‚åœºå‰æ™¯å’Œå•†ä¸šåŒ–æ—¶é—´è¡¨
             - åˆ†ææŠ€æœ¯çš„ä¼˜åŠ¿ã€å±€é™æ€§å’Œå‘å±•ç“¶é¢ˆ
             - å¯¹æ¯”åŒç±»æŠ€æœ¯æ–¹æ¡ˆçš„å·®å¼‚
            """
            
            system_msg = f"ä½ æ˜¯{topic}è¡Œä¸šçš„èµ„æ·±æŠ€æœ¯ä¸“å®¶ï¼Œå…·å¤‡æ·±åšçš„æŠ€æœ¯æ´å¯ŸåŠ›"
            
            if not self.llm_processor:
                return f"## ğŸ”¬ æŠ€æœ¯åˆ›æ–°ä¸æ–°äº§å“æ·±åº¦è§£æ\n\næŠ€æœ¯åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
            
            analysis = self.llm_processor.call_llm_api(enhanced_prompt, system_msg, max_tokens=8000)
            
            # æ·»åŠ ä¿¡æ¯æ¥æº
            sources = []
            for item in innovation_news:
                if item.get('url', '#') != '#':
                    sources.append(f"- [{item.get('title', 'æœªçŸ¥æ ‡é¢˜')}]({item.get('url')}) - {item.get('source', 'æœªçŸ¥æ¥æº')}")
            
            if sources:
                analysis += "\n\n**æŠ€æœ¯èµ„æ–™æ¥æº:**\n" + "\n".join(sources)
            
            elapsed_time = time.time() - start_time
            print(f"âœ… [æŠ€æœ¯åˆ›æ–°åˆ†æ] å¹¶è¡Œåˆ†æå®Œæˆï¼Œè€—æ—¶ {elapsed_time:.1f}ç§’")
            
            return f"## ğŸ”¬ æŠ€æœ¯åˆ›æ–°ä¸æ–°äº§å“æ·±åº¦è§£æ\n\n{analysis}\n\n"
            
        except Exception as e:
            print(f"âŒ [é”™è¯¯] å¹¶è¡ŒæŠ€æœ¯åˆ›æ–°åˆ†ææ—¶å‡ºé”™: {str(e)}")
            return f"## ğŸ”¬ æŠ€æœ¯åˆ›æ–°ä¸æ–°äº§å“æ·±åº¦è§£æ\n\næŠ€æœ¯åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
    
    def get_performance_stats(self) -> Dict[str, Any]:
        """è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "analyzer_type": "InnovationNewsAnalyzer",
            "max_workers": self.max_workers,
            "parallel_tasks": ["innovation_analysis"],
            "estimated_speedup": "1x (single LLM call optimized)"
        } 