"""
æŠ•èµ„åŠ¨æ€æ–°é—»åˆ†æå™¨ - å¹¶è¡Œå¤„ç†ç‰ˆæœ¬
ä¸“é—¨è´Ÿè´£æŠ•èµ„åŠ¨æ€æ–°é—»çš„æ·±åº¦åˆ†æï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
"""

import time
from typing import List, Dict, Any, Optional
import threading

class InvestmentNewsAnalyzer:
    """æŠ•èµ„åŠ¨æ€æ–°é—»åˆ†æå™¨ - å¹¶è¡Œç‰ˆæœ¬"""
    
    def __init__(self, llm_processor, max_workers: int = 2):
        """
        åˆå§‹åŒ–æŠ•èµ„åŠ¨æ€æ–°é—»åˆ†æå™¨
        
        Args:
            llm_processor: LLMå¤„ç†å™¨å®ä¾‹
            max_workers: æœ€å¤§å¹¶è¡Œå·¥ä½œçº¿ç¨‹æ•°
        """
        self.llm_processor = llm_processor
        self.max_workers = max_workers
        self.analysis_lock = threading.Lock()
        
    def analyze_investment_news_parallel(self, topic: str, investment_news: List[Dict]) -> str:
        """
        å¹¶è¡Œåˆ†ææŠ•èµ„åŠ¨æ€æ–°é—»
        
        Args:
            topic: è¡Œä¸šä¸»é¢˜
            investment_news: æŠ•èµ„åŠ¨æ€æ–°é—»åˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„æŠ•èµ„åŠ¨æ€åˆ†ææŠ¥å‘Š
        """
        if not investment_news:
            return f"## ğŸ’° æŠ•èµ„ä¸å¸‚åœºåŠ¨å‘æ·±åº¦åˆ†æ\n\nğŸ“Š **å¸‚åœºè§‚å¯Ÿ**: {topic}è¡Œä¸šæŠ•èµ„æ´»åŠ¨åœ¨å½“å‰æ—¶æ®µç›¸å¯¹å¹³é™ã€‚\n\n"
        
        start_time = time.time()
        print(f"ğŸ’° [æŠ•èµ„åŠ¨æ€åˆ†æ] å¼€å§‹å¹¶è¡Œåˆ†æ{len(investment_news)}ä¸ªæŠ•èµ„äº‹ä»¶...")
        
        try:
            all_news_text = "\n\n".join([
                f"æ ‡é¢˜: {item.get('title', 'æ— æ ‡é¢˜')}\næ—¶é—´: {item.get('date', 'æœªçŸ¥æ—¥æœŸ')}\nå†…å®¹: {item.get('content', 'æ— å†…å®¹')[:500]}...\næ¥æº: {item.get('source', 'æœªçŸ¥')}"
                for item in investment_news
            ])
            
            enhanced_prompt = f"""
            ä½œä¸º{topic}è¡Œä¸šçš„æŠ•èµ„åˆ†æä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹æŠ•èµ„åŠ¨æ€è¿›è¡Œæ™ºèƒ½ç­›é€‰ã€å»é‡å’Œæ·±åº¦è§£è¯»ï¼š
            
            {all_news_text}
            
            ğŸ” **æ™ºèƒ½ç­›é€‰ä»»åŠ¡**ï¼š
            1. **å»é‡è¯†åˆ«**ï¼šè¯†åˆ«ç›¸åŒæŠ•èµ„äº‹ä»¶çš„ä¸åŒæŠ¥é“ï¼Œåˆå¹¶ä¿¡æ¯ä¿ç•™æœ€å®Œæ•´ç‰ˆæœ¬
            2. **é‡è¦æ€§è¯„ä¼°**ï¼šè¯„ä¼°æ¯ä¸ªæŠ•èµ„äº‹ä»¶çš„è§„æ¨¡å’Œå½±å“åŠ›
            3. **å¤šæ ·æ€§ä¿è¯**ï¼šç¡®ä¿æ¶µç›–ä¸åŒæŠ•èµ„ç±»å‹å’Œç»†åˆ†é¢†åŸŸ
            
            ğŸ’° **æŠ•èµ„åˆ†ææ¡†æ¶**:
            1. **èµ„æœ¬æµå‘åˆ†æ**: èµ„é‡‘ä¸»è¦æŠ•å‘å“ªäº›ç»†åˆ†é¢†åŸŸï¼Ÿ
            2. **æŠ•èµ„é€»è¾‘è§£è¯»**: æŠ•èµ„æ–¹çš„æˆ˜ç•¥è€ƒé‡æ˜¯ä»€ä¹ˆï¼Ÿ
            3. **ä¼°å€¼æ°´å¹³è¯„ä¼°**: å½“å‰ä¼°å€¼æ˜¯å¦åˆç†ï¼Ÿ
            4. **å¸‚åœºä¿¡å·è§£è¯»**: è¿™äº›æŠ•èµ„åæ˜ äº†ä»€ä¹ˆå¸‚åœºè¶‹åŠ¿ï¼Ÿ
            5. **é£é™©æœºé‡å¹¶å­˜**: æŠ•èµ„è€…åº”è¯¥å…³æ³¨ä»€ä¹ˆï¼Ÿ
            
            ğŸ¤” **æŠ•èµ„åˆ†æå¸ˆæ€è€ƒè¿‡ç¨‹**:
            - é¦–å…ˆå»é™¤é‡å¤æŠ•èµ„äº‹ä»¶æŠ¥é“ï¼Œåˆå¹¶ç›¸åŒäº‹ä»¶çš„ä¿¡æ¯
            - ç„¶åæ¢³ç†ç‹¬ç‰¹æŠ•èµ„äº‹ä»¶çš„è§„æ¨¡å’Œæ€§è´¨
            - æ¥ç€åˆ†ææŠ•èµ„èƒŒåçš„å•†ä¸šé€»è¾‘
            - è¯„ä¼°å¯¹è¡Œä¸šæ ¼å±€çš„å½±å“
            - æœ€åæå‡ºæŠ•èµ„ç­–ç•¥å»ºè®®
            
            è¯·æä¾›ä¸“ä¸šçš„æŠ•èµ„åˆ†æï¼Œæ³¨é‡æ•°æ®æ”¯æ’‘ï¼Œå­—æ•°2000-2500å­—ã€‚
             
             ğŸ“ **è¯¦ç»†è¦æ±‚**:
             - å¦‚æœå‘ç°ç›¸åŒæŠ•èµ„äº‹ä»¶çš„å¤šä¸ªæŠ¥é“ï¼Œè¯·åˆå¹¶ä¿¡æ¯åªåˆ†æä¸€æ¬¡
             - æ¯ä¸ªç‹¬ç‰¹æŠ•èµ„äº‹ä»¶è¦å•ç‹¬åˆ†æï¼ŒåŒ…å«èƒŒæ™¯ã€åŠ¨æœºã€å½±å“
             - æä¾›å…·ä½“çš„æŠ•èµ„é‡‘é¢ã€ä¼°å€¼å˜åŒ–ã€æŠ•èµ„æ–¹èƒŒæ™¯
             - åˆ†ææŠ•èµ„èƒŒåçš„æˆ˜ç•¥å¸ƒå±€å’Œå¸‚åœºåˆ¤æ–­
             - åŒ…å«é£é™©è¯„ä¼°å’Œæ”¶ç›Šé¢„æœŸåˆ†æ
             - å¯¹æ¯”å†å²æŠ•èµ„æ¡ˆä¾‹ï¼Œè¯†åˆ«è¶‹åŠ¿å˜åŒ–
             - æä¾›å…·ä½“çš„æŠ•èµ„å»ºè®®å’Œæ—¶æœºåˆ¤æ–­
            """
            
            system_msg = f"ä½ æ˜¯{topic}è¡Œä¸šçš„èµ„æ·±æŠ•èµ„åˆ†æå¸ˆï¼Œå…·å¤‡æ•é”çš„å¸‚åœºæ´å¯ŸåŠ›"
            
            if not self.llm_processor:
                return f"## ğŸ’° æŠ•èµ„ä¸å¸‚åœºåŠ¨å‘æ·±åº¦åˆ†æ\n\næŠ•èµ„åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
            
            analysis = self.llm_processor.call_llm_api(enhanced_prompt, system_msg, max_tokens=8000)
            
            # æ·»åŠ ä¿¡æ¯æ¥æº
            sources = []
            for item in investment_news:
                if item.get('url', '#') != '#':
                    sources.append(f"- [{item.get('title', 'æœªçŸ¥æ ‡é¢˜')}]({item.get('url')}) - {item.get('source', 'æœªçŸ¥æ¥æº')}")
            
            if sources:
                analysis += "\n\n**æŠ•èµ„èµ„è®¯æ¥æº:**\n" + "\n".join(sources)
            
            elapsed_time = time.time() - start_time
            print(f"âœ… [æŠ•èµ„åŠ¨æ€åˆ†æ] å¹¶è¡Œåˆ†æå®Œæˆï¼Œè€—æ—¶ {elapsed_time:.1f}ç§’")
            
            return f"## ğŸ’° æŠ•èµ„ä¸å¸‚åœºåŠ¨å‘æ·±åº¦åˆ†æ\n\n{analysis}\n\n"
            
        except Exception as e:
            print(f"âŒ [é”™è¯¯] å¹¶è¡ŒæŠ•èµ„åŠ¨æ€åˆ†ææ—¶å‡ºé”™: {str(e)}")
            return f"## ğŸ’° æŠ•èµ„ä¸å¸‚åœºåŠ¨å‘æ·±åº¦åˆ†æ\n\næŠ•èµ„åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
    
    def get_performance_stats(self) -> Dict[str, Any]:
        """è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "analyzer_type": "InvestmentNewsAnalyzer",
            "max_workers": self.max_workers,
            "parallel_tasks": ["investment_analysis"],
            "estimated_speedup": "1x (single LLM call optimized)"
        } 