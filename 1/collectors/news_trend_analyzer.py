"""
è¡Œä¸šè¶‹åŠ¿æ–°é—»åˆ†æå™¨ - å¹¶è¡Œå¤„ç†ç‰ˆæœ¬
ä¸“é—¨è´Ÿè´£è¡Œä¸šè¶‹åŠ¿æ–°é—»çš„æ·±åº¦åˆ†æï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
"""

import time
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional
import threading

class TrendNewsAnalyzer:
    """è¡Œä¸šè¶‹åŠ¿æ–°é—»åˆ†æå™¨ - å¹¶è¡Œç‰ˆæœ¬"""
    
    def __init__(self, llm_processor, max_workers: int = 2):
        """
        åˆå§‹åŒ–è¡Œä¸šè¶‹åŠ¿æ–°é—»åˆ†æå™¨
        
        Args:
            llm_processor: LLMå¤„ç†å™¨å®ä¾‹
            max_workers: æœ€å¤§å¹¶è¡Œå·¥ä½œçº¿ç¨‹æ•°
        """
        self.llm_processor = llm_processor
        self.max_workers = max_workers
        self.analysis_lock = threading.Lock()
        
    def analyze_trend_news_parallel(self, topic: str, trend_news: List[Dict], days: int = 7) -> str:
        """
        å¹¶è¡Œåˆ†æè¡Œä¸šè¶‹åŠ¿æ–°é—»
        
        Args:
            topic: è¡Œä¸šä¸»é¢˜
            trend_news: è¡Œä¸šè¶‹åŠ¿æ–°é—»åˆ—è¡¨
            days: æ—¶é—´èŒƒå›´ï¼ˆå¤©æ•°ï¼‰
            
        Returns:
            æ ¼å¼åŒ–çš„è¡Œä¸šè¶‹åŠ¿åˆ†ææŠ¥å‘Š
        """
        if not trend_news:
            return f"## ğŸ“ˆ è¡Œä¸šè¶‹åŠ¿æ·±åº¦åˆ†æ\n\nğŸ“Š **è¶‹åŠ¿è§‚å¯Ÿ**: åŸºäºæœ€è¿‘{days}å¤©çš„æ•°æ®ï¼Œ{topic}è¡Œä¸šè¶‹åŠ¿åˆ†ææœ‰é™ã€‚\n\n"
        
        start_time = time.time()
        print(f"ğŸ“ˆ [è¡Œä¸šè¶‹åŠ¿åˆ†æ] å¼€å§‹å¹¶è¡Œåˆ†æ{len(trend_news)}ä¸ªè¡Œä¸šè¶‹åŠ¿...")
        
        try:
            # è®¡ç®—æ—¶é—´èŒƒå›´
            today = datetime.now()
            start_date = today - timedelta(days=days)
            time_range = f"{start_date.strftime('%Yå¹´%mæœˆ%dæ—¥')} è‡³ {today.strftime('%Yå¹´%mæœˆ%dæ—¥')}"
            
            all_news_text = "\n\n".join([
                f"æ ‡é¢˜: {item.get('title', 'æ— æ ‡é¢˜')}\nå†…å®¹: {item.get('content', 'æ— å†…å®¹')[:500]}...\næ¥æº: {item.get('source', 'æœªçŸ¥')}"
                for item in trend_news
            ])
            
            enhanced_prompt = f"""
            ä½œä¸º{topic}è¡Œä¸šçš„é¦–å¸­è¶‹åŠ¿åˆ†æå¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹**{time_range}**ï¼ˆæœ€è¿‘{days}å¤©ï¼‰æœŸé—´çš„è¡Œä¸šè¶‹åŠ¿è¿›è¡Œæ·±åº¦åˆ†æï¼š
            
            {all_news_text}
            
            âš ï¸ **æ—¶é—´èŒƒå›´é™åˆ¶**: æœ¬åˆ†æä¸¥æ ¼èšç„¦äº{time_range}è¿™ä¸ªæ—¶é—´çª—å£å†…çš„è¶‹åŠ¿ä¿¡å·ï¼Œä¸æ¶‰åŠæ›´æ—©æœŸçš„å†å²è¶‹åŠ¿ã€‚
            
            ğŸ“ˆ **è¶‹åŠ¿åˆ†ææ¡†æ¶**:
            1. **è¿‘æœŸè¶‹åŠ¿è¯†åˆ«**: æœ€è¿‘{days}å¤©å†…{topic}è¡Œä¸šå‡ºç°äº†å“ªäº›æ–°çš„å‘å±•è¶‹åŠ¿ï¼Ÿ
            2. **é©±åŠ¨å› ç´ åˆ†æ**: ä»€ä¹ˆåŠ›é‡åœ¨æ¨åŠ¨è¿™äº›æœ€æ–°è¶‹åŠ¿ï¼Ÿ
            3. **å½±å“ç¨‹åº¦è¯„ä¼°**: è¿™äº›æ–°è¶‹åŠ¿å¯¹è¡Œä¸šæ ¼å±€çš„å³æ—¶å’ŒçŸ­æœŸå½±å“ï¼Ÿ
            4. **å‘å±•è½¨è¿¹é¢„æµ‹**: åŸºäºè¿‘æœŸä¿¡å·ï¼Œè¿™äº›è¶‹åŠ¿çš„ä¸‹ä¸€æ­¥å‘å±•æ–¹å‘ï¼Ÿ
            5. **æœºé‡æŒ‘æˆ˜å¹¶å­˜**: æ–°è¶‹åŠ¿å¸¦æ¥çš„å³æ—¶æœºé‡å’Œé£é™©ï¼Ÿ
            
            ğŸ¤” **è¶‹åŠ¿åˆ†æå¸ˆæ€è€ƒè¿‡ç¨‹**:
            - é¦–å…ˆä»æœ€æ–°æ•°æ®ä¸­è¯†åˆ«è¶‹åŠ¿ä¿¡å·
            - ç„¶ååˆ†æè¿‘æœŸè¶‹åŠ¿ä¹‹é—´çš„ç›¸äº’å…³ç³»
            - æ¥ç€è¯„ä¼°è¶‹åŠ¿çš„ç´§è¿«æ€§å’Œå½±å“åŠ›
            - æœ€ååŸºäºæœ€æ–°å˜åŒ–é¢„æµ‹çŸ­æœŸå‘å±•è½¨è¿¹
            
            è¯·æä¾›åŸºäºè¿‘æœŸæ•°æ®çš„å‰ç»æ€§è¶‹åŠ¿åˆ†æï¼Œè¦æœ‰å…·ä½“çš„æ•°æ®æ”¯æ’‘å’Œæ¡ˆä¾‹è¯´æ˜ï¼Œå­—æ•°1500-2000å­—ã€‚
            
            ğŸ“ **åˆ†æè¦æ±‚**:
            - **ä¸¥æ ¼èšç„¦æ—¶é—´èŒƒå›´**: åªåˆ†æ{time_range}å†…çš„è¶‹åŠ¿ä¿¡å·
            - æ„å»ºåŸºäºæœ€æ–°æ•°æ®çš„è¶‹åŠ¿åˆ†ææ¡†æ¶
            - æ¯ä¸ªè¶‹åŠ¿éƒ½è¦è¯¦ç»†å±•å¼€ï¼ŒåŒ…å«æœ€æ–°é©±åŠ¨å› ç´ å’Œå‘å±•é˜¶æ®µ
            - æä¾›åŸºäºè¿‘æœŸå˜åŒ–çš„å…·ä½“é¢„æµ‹å’Œé‡åŒ–æŒ‡æ ‡
            - åˆ†ææœ€æ–°è¶‹åŠ¿ä¹‹é—´çš„ç›¸äº’å…³ç³»å’ŒååŒæ•ˆåº”
            - è¯†åˆ«æ½œåœ¨çš„æ–°å…´å˜åŒ–å’Œçªå‘å› ç´ 
            - æ„å»ºåŸºäºå½“å‰çŠ¶å†µçš„åº”å¯¹ç­–ç•¥
            - æä¾›çŸ­æœŸå†…çš„å…³é”®æ—¶é—´èŠ‚ç‚¹å’Œå‘å±•è·¯å¾„
            
            ğŸš« **é¿å…å†…å®¹**: 
            - ä¸è¦å¼•ç”¨{time_range}ä¹‹å¤–çš„å†å²è¶‹åŠ¿æ•°æ®
            - ä¸è¦è¿›è¡Œé•¿æœŸå†å²è¶‹åŠ¿çš„å›é¡¾åˆ†æ
            - ä¸“æ³¨äºå½“å‰æ—¶é—´çª—å£å†…çš„å…·ä½“è¶‹åŠ¿å˜åŒ–
            """
            
            system_msg = f"ä½ æ˜¯{topic}è¡Œä¸šçš„èµ„æ·±è¶‹åŠ¿åˆ†æä¸“å®¶ï¼Œå…·å¤‡å“è¶Šçš„å‰ç»æ€§åˆ¤æ–­èƒ½åŠ›"
            
            if not self.llm_processor:
                return f"## ğŸ“ˆ è¡Œä¸šè¶‹åŠ¿æ·±åº¦åˆ†æ\n\nè¶‹åŠ¿åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
            
            analysis = self.llm_processor.call_llm_api(enhanced_prompt, system_msg, max_tokens=8000)
            
            # æ·»åŠ ä¿¡æ¯æ¥æº
            sources = []
            for item in trend_news:
                if item.get('url', '#') != '#':
                    sources.append(f"- [{item.get('title', 'æœªçŸ¥æ ‡é¢˜')}]({item.get('url')}) - {item.get('source', 'æœªçŸ¥æ¥æº')}")
            
            if sources:
                analysis += "\n\n**è¶‹åŠ¿æ•°æ®æ¥æº:**\n" + "\n".join(sources)
            
            elapsed_time = time.time() - start_time
            print(f"âœ… [è¡Œä¸šè¶‹åŠ¿åˆ†æ] å¹¶è¡Œåˆ†æå®Œæˆï¼Œè€—æ—¶ {elapsed_time:.1f}ç§’")
            
            return f"## ğŸ“ˆ è¡Œä¸šè¶‹åŠ¿æ·±åº¦åˆ†æ\n\n{analysis}\n\n"
            
        except Exception as e:
            print(f"âŒ [é”™è¯¯] å¹¶è¡Œè¡Œä¸šè¶‹åŠ¿åˆ†ææ—¶å‡ºé”™: {str(e)}")
            return f"## ğŸ“ˆ è¡Œä¸šè¶‹åŠ¿æ·±åº¦åˆ†æ\n\nè¶‹åŠ¿åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
    
    def get_performance_stats(self) -> Dict[str, Any]:
        """è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "analyzer_type": "TrendNewsAnalyzer",
            "max_workers": self.max_workers,
            "parallel_tasks": ["trend_analysis"],
            "estimated_speedup": "1x (single LLM call optimized)"
        } 