"""
æ”¿ç­–ç›‘ç®¡æ–°é—»åˆ†æå™¨ - å¹¶è¡Œå¤„ç†ç‰ˆæœ¬
ä¸“é—¨è´Ÿè´£æ”¿ç­–ç›‘ç®¡æ–°é—»çš„æ·±åº¦åˆ†æï¼Œæ”¯æŒå¹¶è¡Œå¤„ç†
"""

import time
from typing import List, Dict, Any, Optional
import threading

class PolicyNewsAnalyzer:
    """æ”¿ç­–ç›‘ç®¡æ–°é—»åˆ†æå™¨ - å¹¶è¡Œç‰ˆæœ¬"""
    
    def __init__(self, llm_processor, max_workers: int = 2):
        """
        åˆå§‹åŒ–æ”¿ç­–ç›‘ç®¡æ–°é—»åˆ†æå™¨
        
        Args:
            llm_processor: LLMå¤„ç†å™¨å®ä¾‹
            max_workers: æœ€å¤§å¹¶è¡Œå·¥ä½œçº¿ç¨‹æ•°
        """
        self.llm_processor = llm_processor
        self.max_workers = max_workers
        self.analysis_lock = threading.Lock()
        
    def analyze_policy_news_parallel(self, topic: str, policy_news: List[Dict]) -> str:
        """
        å¹¶è¡Œåˆ†ææ”¿ç­–ç›‘ç®¡æ–°é—»
        
        Args:
            topic: è¡Œä¸šä¸»é¢˜
            policy_news: æ”¿ç­–ç›‘ç®¡æ–°é—»åˆ—è¡¨
            
        Returns:
            æ ¼å¼åŒ–çš„æ”¿ç­–ç›‘ç®¡åˆ†ææŠ¥å‘Š
        """
        if not policy_news:
            return f"## ğŸ“œ æ”¿ç­–ä¸ç›‘ç®¡åŠ¨æ€æ·±åº¦è§£è¯»\n\nğŸ“Š **æ”¿ç­–ç›‘æµ‹**: {topic}è¡Œä¸šæ”¿ç­–ç¯å¢ƒåœ¨å½“å‰æ—¶æ®µä¿æŒç¨³å®šã€‚\n\n"
        
        start_time = time.time()
        print(f"ğŸ“œ [æ”¿ç­–ç›‘ç®¡åˆ†æ] å¼€å§‹å¹¶è¡Œåˆ†æ{len(policy_news)}é¡¹æ”¿ç­–åŠ¨æ€...")
        
        try:
            all_news_text = "\n\n".join([
                f"æ ‡é¢˜: {item.get('title', 'æ— æ ‡é¢˜')}\nå†…å®¹: {item.get('content', 'æ— å†…å®¹')[:500]}...\næ¥æº: {item.get('source', 'æœªçŸ¥')}"
                for item in policy_news
            ])
            
            enhanced_prompt = f"""
            ä½œä¸º{topic}è¡Œä¸šçš„æ”¿ç­–åˆ†æä¸“å®¶ï¼Œè¯·å¯¹ä»¥ä¸‹æ”¿ç­–åŠ¨æ€è¿›è¡Œæ™ºèƒ½ç­›é€‰ã€å»é‡å’Œæ·±åº¦è§£è¯»ï¼š
            
            {all_news_text}
            
            ğŸ” **æ™ºèƒ½ç­›é€‰ä»»åŠ¡**ï¼š
            1. **å»é‡è¯†åˆ«**ï¼šè¯†åˆ«ç›¸åŒæ”¿ç­–çš„ä¸åŒæŠ¥é“ï¼Œåˆå¹¶ä¿¡æ¯ä¿ç•™æœ€æƒå¨ç‰ˆæœ¬
            2. **é‡è¦æ€§è¯„ä¼°**ï¼šè¯„ä¼°æ¯é¡¹æ”¿ç­–å¯¹{topic}è¡Œä¸šçš„å½±å“ç¨‹åº¦
            3. **å¤šæ ·æ€§ä¿è¯**ï¼šç¡®ä¿æ¶µç›–ä¸åŒå±‚çº§å’Œç±»å‹çš„æ”¿ç­–åŠ¨æ€
            
            ğŸ“œ **æ”¿ç­–åˆ†ææ¡†æ¶**:
            1. **æ”¿ç­–å†…å®¹è§£è¯»**: æ ¸å¿ƒæ”¿ç­–æªæ–½å’Œè§„å®šæ˜¯ä»€ä¹ˆï¼Ÿ
            2. **æ”¿ç­–æ„å›¾åˆ†æ**: æ”¿åºœå¸Œæœ›è¾¾åˆ°ä»€ä¹ˆç›®æ ‡ï¼Ÿ
            3. **è¡Œä¸šå½±å“è¯„ä¼°**: å¯¹{topic}è¡Œä¸šå„ç¯èŠ‚çš„å…·ä½“å½±å“ï¼Ÿ
            4. **ä¼ä¸šåº”å¯¹ç­–ç•¥**: ä¼ä¸šåº”è¯¥å¦‚ä½•è°ƒæ•´æˆ˜ç•¥ï¼Ÿ
            5. **æ”¿ç­–è¶‹åŠ¿é¢„åˆ¤**: æœªæ¥æ”¿ç­–èµ°å‘å¦‚ä½•ï¼Ÿ
            
            ğŸ¤” **æ”¿ç­–åˆ†æå¸ˆæ€è€ƒè¿‡ç¨‹**:
            - é¦–å…ˆå»é™¤é‡å¤æ”¿ç­–æŠ¥é“ï¼Œåˆå¹¶ç›¸åŒæ”¿ç­–çš„ä¿¡æ¯
            - ç„¶åç†è§£ç‹¬ç‰¹æ”¿ç­–çš„èƒŒæ™¯å’Œç›®æ ‡
            - æ¥ç€åˆ†ææ”¿ç­–çš„å®æ–½è·¯å¾„å’Œæ—¶é—´èŠ‚ç‚¹
            - è¯„ä¼°å¯¹ä¸åŒä¼ä¸šçš„å·®å¼‚åŒ–å½±å“
            - æœ€åæå‡ºåˆè§„å’Œå‘å±•å»ºè®®
            
            è¯·æä¾›æƒå¨ã€å®¢è§‚çš„æ”¿ç­–è§£è¯»ï¼Œå­—æ•°1800-2200å­—ã€‚
             
             ğŸ“ **æ·±åº¦è¦æ±‚**:
             - å¦‚æœå‘ç°ç›¸åŒæ”¿ç­–çš„å¤šä¸ªæŠ¥é“ï¼Œè¯·åˆå¹¶ä¿¡æ¯åªåˆ†æä¸€æ¬¡
             - æ¯é¡¹ç‹¬ç‰¹æ”¿ç­–éƒ½è¦è¯¦ç»†è§£è¯»æ¡æ–‡å†…å®¹å’Œå®æ–½ç»†åˆ™
             - åˆ†ææ”¿ç­–å‡ºå°çš„èƒŒæ™¯ã€ç›®æ ‡å’Œé¢„æœŸæ•ˆæœ
             - è¯„ä¼°å¯¹ä¸åŒç±»å‹ä¼ä¸šçš„å·®å¼‚åŒ–å½±å“
             - æä¾›å…·ä½“çš„åˆè§„å»ºè®®å’Œæ“ä½œæŒ‡å—
             - é¢„æµ‹æ”¿ç­–æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½çš„æŒ‘æˆ˜å’Œæœºé‡
             - å¯¹æ¯”å›½é™…åŒç±»æ”¿ç­–çš„ç»éªŒå’Œå¯ç¤º
            """
            
            system_msg = f"ä½ æ˜¯{topic}è¡Œä¸šçš„æ”¿ç­–åˆ†æä¸“å®¶ï¼Œå…·å¤‡æ·±åšçš„æ”¿ç­–ç†è§£èƒ½åŠ›"
            
            if not self.llm_processor:
                return f"## ğŸ“œ æ”¿ç­–ä¸ç›‘ç®¡åŠ¨æ€æ·±åº¦è§£è¯»\n\næ”¿ç­–åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
            
            analysis = self.llm_processor.call_llm_api(enhanced_prompt, system_msg, max_tokens=8000)
            
            # æ·»åŠ ä¿¡æ¯æ¥æº
            sources = []
            for item in policy_news:
                if item.get('url', '#') != '#':
                    sources.append(f"- [{item.get('title', 'æœªçŸ¥æ ‡é¢˜')}]({item.get('url')}) - {item.get('source', 'æœªçŸ¥æ¥æº')}")
            
            if sources:
                analysis += "\n\n**æ”¿ç­–ä¿¡æ¯æ¥æº:**\n" + "\n".join(sources)
            
            elapsed_time = time.time() - start_time
            print(f"âœ… [æ”¿ç­–ç›‘ç®¡åˆ†æ] å¹¶è¡Œåˆ†æå®Œæˆï¼Œè€—æ—¶ {elapsed_time:.1f}ç§’")
            
            return f"## ğŸ“œ æ”¿ç­–ä¸ç›‘ç®¡åŠ¨æ€æ·±åº¦è§£è¯»\n\n{analysis}\n\n"
            
        except Exception as e:
            print(f"âŒ [é”™è¯¯] å¹¶è¡Œæ”¿ç­–ç›‘ç®¡åˆ†ææ—¶å‡ºé”™: {str(e)}")
            return f"## ğŸ“œ æ”¿ç­–ä¸ç›‘ç®¡åŠ¨æ€æ·±åº¦è§£è¯»\n\næ”¿ç­–åˆ†ææš‚æ—¶ä¸å¯ç”¨ã€‚\n\n"
    
    def get_performance_stats(self) -> Dict[str, Any]:
        """è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "analyzer_type": "PolicyNewsAnalyzer",
            "max_workers": self.max_workers,
            "parallel_tasks": ["policy_analysis"],
            "estimated_speedup": "1x (single LLM call optimized)"
        } 